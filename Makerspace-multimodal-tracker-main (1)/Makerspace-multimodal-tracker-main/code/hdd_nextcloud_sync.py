import scheduleimport subprocessimport shleximport argparseimport osimport datetimeimport timeimport globimport logging# function to execute command in shelldef run_command(command):    process = subprocess.Popen(shlex.split(command), stdout=subprocess.PIPE)    while True:        output = process.stdout.readline()        logging.info(output)        if process.poll() is not None:            break        if output:            print(output.strip())    rc = process.poll()    return rc# function to create directoriesdef create_dir(target_dir):    if not os.path.exists(target_dir):        try:            os.makedirs(target_dir)        except:            pass        # helper function to create day folderdef create_day_folder(base_dir,system_date=None,setup=True):        if system_date == None:        dt_system_date = datetime.datetime.now()    else:        dt_system_date = datetime.datetime.strptime(system_date,'%Y-%m-%d')         year = str(dt_system_date.year)    month = str(dt_system_date.month)    day = str(dt_system_date.day)        day_folder = base_dir + '{}-{}-{}/'.format(year,month,day)    day_string = '{}-{}-{}'.format(year,month,day)                    if setup:        create_dir(day_folder)            return day_folder, day_string    # helper function for time stringdef get_str(dt_subobject):        out = str(dt_subobject)        if len(out) == 1:            out = '0' + out        return out# helper function to get timedef get_time(system_start=None,system_date=None):        if system_start == None:        dt_system_start = datetime.datetime.now()    else:        dt_system_start = datetime.datetime.strptime(system_start,'%H:%M')        if system_date == None:        dt_system_date = datetime.datetime.now()    else:        dt_system_date = datetime.datetime.strptime(system_date,'%Y-%m-%d')         hour = get_str(dt_system_start.hour)    minute = get_str(dt_system_start.minute)    second = get_str(dt_system_start.second)        year = get_str(dt_system_date.year)    month = get_str(dt_system_date.month)    day = get_str(dt_system_date.day)        out_date = '{}-{}-{}'.format(year,month,day)    out_time = '{}:{}:{}'.format(hour,minute,second)        return out_date, out_time# function to write recordsdef write_record(record_file,output):    with open(record_file,"a") as f:        f.write(output+' \n')# function to read records    def read_record(record_file):    with open(record_file,"r") as f:        raw_video_ids = f.readlines()            final_video_ids = []    for video_id in raw_video_ids:        final_video_ids.append(video_id.split(" ")[0])            return final_video_ids        # function for nextcloud copydef hdd_copy(remove_local=True):            # obtain copy time    copy_date, copy_time = get_time()    dt_copy_time = datetime.datetime.strptime('{}_{}'.format(copy_date,copy_time),'%Y-%m-%d_%H:%M:%S')        # copy videos    for webcam_id in webcam_ids:                # obtain relevant folders        webcam_dir = webcam_dirs[webcam_id]        webcam_video_store_folder = webcam_video_store_folders[webcam_id]        hdd_webcam_dir = hdd_webcam_dirs[webcam_id]                        # obtain videos in video store folder        store_videos = sorted(glob.glob(webcam_video_store_folder+'*.mp4'))                # read record file        upload_record = webcam_dir + 'hdd_record.txt'        try:             copied_videos = read_record(upload_record)        except:            write_record(upload_record,'')            copied_videos = read_record(upload_record)                for store_video in store_videos:                        # obtain video information            video_id = store_video.split('/')[-1].split('.')[0]            dt_video_time = datetime.datetime.strptime(video_id.split('_')[-1],'%Y-%m-%d-%H-%M-%S')            time_diff = (dt_copy_time - dt_video_time).total_seconds() / 60                        # only copy store videos that were processed at least 15 minutes before            if time_diff > 15:                                 if video_id in copied_videos:                    if remove_local:                        os.remove(store_video)                        logging.info('\nDelete local copy of {}'.format(video_id))                else:                    logging.info('\nStarting hdd copy for {}'.format(video_id))                                        # copy store video to nextcloud                    command_line_copy = 'cp {} {}'.format(store_video,hdd_webcam_dir)                    run_command(command_line_copy)                                                            logging.info('\nEnding hdd copy for {}'.format(video_id))                    write_record(upload_record,video_id)    # function for nextcloud copydef nextcloud_sync():        # sync videos    for webcam_id in webcam_ids:                # obtain relevant folders        hdd_webcam_dir = hdd_webcam_dirs[webcam_id]        cloud_url_webcam_dir = cloud_url_webcam_dirs[webcam_id]                # log        sync_date, sync_time = get_time()        logging.info('\nStarting nextcloud sync at {}'.format(sync_time))                # sync video to next cloud        command_line_copy = "nextcloudcmd --trust --user litlab --password 'W&7uLpAgm&T&Wj7H' {} {}".format(hdd_webcam_dir,cloud_url_webcam_dir)        run_command(command_line_copy)                # log        sync_date, sync_time = get_time()        logging.info('\nEnding nextcloud sync at {}'.format(sync_time))                """----------------------------- options -----------------------------"""parser = argparse.ArgumentParser(description='HDD Copy')parser.add_argument('--station', type=int,                    help='id for station')parser.add_argument('--webcams', type=str,                    help='list of ids for webcam')parser.add_argument('--output_dir', type=str, default='../outputs/',                    help='location of output drive')parser.add_argument('--hdd_dir', type=str,                    help='location of external hard disc drive')parser.add_argument('--nextcloud_dir', type=str,                    help='location of nextcloud drive')parser.add_argument('--nextcloud_url', type=str, default='https://ncdrive.gse.harvard.edu/remote.php/webdav/Litlab/Makerspace/',                    help='url of nextcloud drive')parser.add_argument('--sync_date', default=None,                    help='which date to sync, %Y-%m-%d')args = parser.parse_args()if __name__ == "__main__":        # create necessary variables    code_dir = os.getcwd() +'/'    station_id = args.station    webcam_ids = eval(args.webcams)    sync_date = args.sync_date    os.chdir(args.output_dir)    output_dir = os.getcwd() +'/'    os.chdir(args.hdd_dir)    hdd_dir = os.getcwd() +'/'    print('HDD Directory - {}'.format(hdd_dir))    os.chdir(args.nextcloud_dir)    nextcloud_dir = os.getcwd() +'/'    print('Next Cloud Directory - {}'.format(nextcloud_dir))    nextcloud_url = args.nextcloud_url    print('Next Cloud URL - {}'.format(nextcloud_url))    os.chdir(code_dir)        # create folders     station_dir = output_dir + 'station_{}/'.format(station_id)        hdd_day_folder, _ = create_day_folder(hdd_dir,system_date=sync_date,setup=True)    cloud_day_folder, _ = create_day_folder(nextcloud_dir,system_date=sync_date,setup=True)    cloud_url_day_folder, _ = create_day_folder(nextcloud_url,system_date=sync_date,setup=False)        webcam_dirs = {}    webcam_video_store_folders = {}    hdd_webcam_dirs = {}    cloud_webcam_dirs = {}    cloud_url_webcam_dirs = {}    for webcam_id in webcam_ids:        camera_id = '{}_{}'.format(station_id,webcam_id)                webcam_dir = station_dir + 'webcam_{}/'.format(webcam_id)        webcam_dirs[webcam_id] = webcam_dir                webcam_video_store_folder = webcam_dir + 'video_store/'        webcam_video_store_folders[webcam_id] = webcam_video_store_folder            hdd_webcam_dir = hdd_day_folder + '{}/'.format(camera_id)        hdd_webcam_dirs[webcam_id] = hdd_webcam_dir                cloud_url_webcam_dir = cloud_url_day_folder + '{}/'.format(camera_id)        cloud_url_webcam_dirs[webcam_id] = cloud_url_webcam_dir                cloud_webcam_dir = cloud_day_folder + '{}/'.format(camera_id)        cloud_webcam_dirs[webcam_id] = cloud_webcam_dir                # create dirs in hdd and cloud        create_dir(hdd_webcam_dir)        create_dir(cloud_webcam_dir)        # logging    log_file = "{}/hdd_nextcloud_sync.log".format(station_dir)    fmtstr = " %(asctime)s: (%(filename)s): %(levelname)s: %(funcName)s Line: %(lineno)d - %(message)s"    datestr = "%m/%d/%Y %I:%M:%S %p "    logging.basicConfig(        filename=log_file,        level=logging.DEBUG,        filemode="w",        format=fmtstr,        datefmt=datestr,    )            # schedule jobs    hdd_job = schedule.every(15).minutes.do(hdd_copy)    nextcloud_job = schedule.every(15).minutes.do(nextcloud_sync)        # start scheduler    try:        while True:            schedule.run_pending()            time.sleep(1)    except KeyboardInterrupt:        print('\nEnding scheduler...')