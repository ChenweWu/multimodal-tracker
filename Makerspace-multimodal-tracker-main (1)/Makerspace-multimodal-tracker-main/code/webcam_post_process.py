import osimport argparseimport pandas as pdimport globimport subprocessimport shleximport datetimeimport scheduleimport time# function to execute command in shelldef run_command(command):    process = subprocess.Popen(shlex.split(command), stdout=subprocess.PIPE)    while True:        output = process.stdout.readline()        if process.poll() is not None:            break        if output:            print(output.strip())    rc = process.poll()    return rc# function to execute command in shell and save output to filedef run_command_out(command,outfile):    process = subprocess.Popen(shlex.split(command), stdout=subprocess.PIPE)    while True:        output = process.stdout.readline()        with open(outfile,"ab") as f:            f.write(output)        if process.poll() is not None:            break        if output:            print(output.strip())    rc = process.poll()    return rc# function to create directoriesdef create_dir(target_dir):    if not os.path.exists(target_dir):        try:            os.makedirs(target_dir)        except:            pass# helper function for time stringdef get_str(dt_subobject):        out = str(dt_subobject)        if len(out) == 1:            out = '0' + out        return out# helper function for micro time stringdef get_micro_str(dt_subobject):    out = str(dt_subobject)    no_zeros = 6 - len(out)    out = no_zeros*'0' + out    return out# convert unix to datetimedef convert_unix(timestamp):    unix_conversion = datetime.datetime.fromtimestamp(timestamp).strftime('%Y-%m-%d %H:%M:%S.%f')    return unix_conversion# function format datetime objectdef timestamp_format(dt_object):        year = get_str(dt_object.year)    month = get_str(dt_object.month)    day = get_str(dt_object.day)    hour = get_str(dt_object.hour)    minute = get_str(dt_object.minute)    second = get_str(dt_object.second)    microsecond = get_micro_str(dt_object.microsecond)        timestamp_str = '{}-{}-{}T{}:{}:{}.{}+00:00'.format(year,month,day,hour,minute,second,microsecond)                                  return timestamp_str# helper function to get timedef get_time(system_start=None,system_date=None):        if system_start == None:        dt_system_start = datetime.datetime.now()    else:        dt_system_start = datetime.datetime.strptime(system_start,'%H:%M')        if system_date == None:        dt_system_date = datetime.datetime.now()    else:        dt_system_date = datetime.datetime.strptime(system_date,'%Y-%m-%d')         hour = get_str(dt_system_start.hour)    minute = get_str(dt_system_start.minute)    second = get_str(dt_system_start.second)        year = get_str(dt_system_date.year)    month = get_str(dt_system_date.month)    day = get_str(dt_system_date.day)        out_date = '{}-{}-{}'.format(year,month,day)    out_time = '{}:{}:{}'.format(hour,minute,second)        return out_date, out_time    # helper function to create time folders in directorydef get_time_folder(base_dir,system_start,system_date=None,time_level='day',setup=True):        if system_date == None:        dt_system_date = datetime.datetime.now()        dt_system_start = datetime.datetime.strptime(system_start,'%H:%M')    else:        dt_system_date = datetime.datetime.strptime(system_date,'%Y-%m-%d')         dt_system_start = datetime.datetime.strptime(system_start,'%H:%M')         year = str(dt_system_date.year)    month = str(dt_system_date.month)    day = str(dt_system_date.day)        hour = str(dt_system_start.hour)    minute = str(dt_system_start.minute)    year_folder = base_dir + '{}/'.format(year)    month_folder = year_folder + '{}/'.format(month)    day_folder = month_folder + '{}/'.format(day)             if time_level == 'min':        time_folder = day_folder + '{}_{}/'.format(hour,minute)        time_string = '{}-{}-{}_{}-{}'.format(year,month,day,hour,minute)    elif time_level == 'hr':        time_folder = day_folder + '{}/'.format(hour)        time_string = '{}-{}-{}_{}'.format(year,month,day,hour)    elif time_level == 'day':        time_folder = day_folder        time_string = '{}-{}-{}'.format(year,month,day)                    if setup:        create_dir(year_folder)        create_dir(month_folder)        create_dir(day_folder)        create_dir(time_folder)            return time_folder, time_string# process to setup time foldersdef time_folders_setup(webcam_dir,system_start,system_date=None,time_level='day',setup=True):        # get time folders    time_folder, _ = get_time_folder(webcam_dir,system_start,system_date=system_date,time_level=time_level,setup=setup)        # obtain output folders    video_store_folder = time_folder + 'video_store'    video_alphapose_folder = time_folder + 'video_alphapose/'        # obtain info folders    info_dir = time_folder + 'info/'    video_info_folder = info_dir + 'video_info/'        # create folders    if setup:        create_dir(video_store_folder)        #create_dir(video_alphapose_folder)        #create_dir(info_dir)        #create_dir(video_info_folder)        return video_store_folder, video_alphapose_folder,info_dir,video_info_folder# helper function to convert videodef convert_video(input_video,output_video,new_resolution=None,new_fps=None):              old_video = '"{}"'.format(input_video)    new_video = '"{}"'.format(output_video)        # convert video to new resolution and new fps    if new_resolution!=None and new_fps!=None:        raise Exception('Only change resolution or fps!')            # convert video to new resolution    elif new_resolution!=None and new_fps==None:        command_line = 'ffmpeg -i {} -preset ultrafast -copyts -vf scale={}:{} {}'.format(old_video,new_resolution[0],new_resolution[1],new_video)        run_command(command_line)      # convert video to new fps    elif new_resolution==None and new_fps!=None:        command_line = 'ffmpeg -i {} -preset ultrafast -copyts -vf fps={} {}'.format(old_video,new_fps,new_video)        run_command(command_line)            # convert video to new codec    elif new_resolution==None and new_fps==None:        command_line = 'ffmpeg -i {} -preset ultrafast -copyts {}'.format(old_video,new_video)        run_command(command_line)# helper function to convert store videodef convert_store_video(target_video,video_id,video_store_folder):        # convert raw video to store video    store_video = '{}{}.mp4'.format(video_store_folder,video_id)    convert_video(target_video,store_video)        # remove raw video    os.remove(target_video)        return store_video# helper function to convert alphapose videodef convert_alphapose_video(target_video,video_id,video_alphapose_folder,video_info_folder,df_webcam_new,df_image_timestamps):        # copy df    f_df_webcam_new = df_webcam_new.copy()    f_df_image_timestamps = df_image_timestamps.copy()        # convert video for alphapose process    alphapose_video_temp = '{}{}_temp.mp4'.format(video_alphapose_folder,video_id)    convert_video(target_video,alphapose_video_temp,new_resolution=[1920,1080])        alphapose_video = '{}{}.mp4'.format(video_alphapose_folder,video_id)    convert_video(alphapose_video_temp,alphapose_video,new_fps=15)    os.remove(alphapose_video_temp)        # extract video information from newly created alphapose video    video_info_out = '{}{}_raw_info.csv'.format(video_info_folder,video_id)    alphapose_video = '"{}{}.mp4"'.format(video_alphapose_folder,video_id)        command_line = 'ffprobe -v error -hide_banner -print_format csv -show_entries stream=width,height,avg_frame_rate,start_time,duration,nb_frames {}'.format(alphapose_video)    run_command_out(command_line,video_info_out)        df_video_info = pd.read_csv(video_info_out,header=None)         width = df_video_info[1].values[0]    height = df_video_info[2].values[0]    fps = eval(df_video_info[3].values[0])    start_time = timestamp_format(datetime.datetime.strptime(convert_unix(df_video_info[4].values[0]),'%Y-%m-%d %H:%M:%S.%f'))    end_time =  timestamp_format(datetime.datetime.strptime(convert_unix(df_video_info[5].values[0]),'%Y-%m-%d %H:%M:%S.%f'))    no_frames = df_video_info[6].values[0]    f_df_webcam_new = f_df_webcam_new.append({'video_id': video_id,                                            'video_path': alphapose_video,                                            'no_of_images':no_frames,                                            'start_time':start_time,                                            'end_time':end_time,                                            'fps':fps,                                            'image_width':width,                                            'image_height':height},ignore_index=True)      # extract timestamps for each frame    frame_ts_out = '{}{}_raw_frame_ts.csv'.format(video_info_folder,video_id)    command_line = 'ffprobe -v error -hide_banner -print_format csv -show_entries frame=best_effort_timestamp_time {}'.format(alphapose_video)    run_command_out(command_line,frame_ts_out)        df_frame_ts_out = pd.read_csv(frame_ts_out,header=None)         for i, row in df_frame_ts_out.iterrows():        timestamp = timestamp_format(datetime.datetime.strptime(convert_unix(row[1]),'%Y-%m-%d %H:%M:%S.%f'))        f_df_image_timestamps = f_df_image_timestamps.append({'video_id':video_id,                                                            'video_path': alphapose_video,                                                            'image_no':i,                                                            'timestamp':timestamp},ignore_index=True)        # remove unwanted files    os.remove(video_info_out)    os.remove(frame_ts_out)        return f_df_webcam_new, f_df_image_timestamps# process webcam informationdef webcam_post_process(f_webcam_dir,convert_store=False,convert_alphapose=False):        def get_str(dt_subobject):        out = str(dt_subobject)        if len(out) == 1:            out = '0' + out        return out        # obtain process time    process_date, process_time = get_time()    dt_process_time = datetime.datetime.strptime('{}_{}'.format(process_date,process_time),'%Y-%m-%d_%H:%M:%S')            # create main folders    video_raw_folder = f_webcam_dir + 'video_raw/'    video_store_folder = f_webcam_dir + 'video_store/'    video_alphapose_folder = f_webcam_dir + 'video_alphapose/'    info_dir = f_webcam_dir + 'info/'    video_info_folder = info_dir + 'video_info/'       create_dir(video_store_folder)    #create_dir(video_alphapose_folder)    #create_dir(info_dir)    #create_dir(video_info_folder)        # create dataframes    df_webcam_new = pd.DataFrame(columns=['video_id','video_path','no_of_images','start_time','end_time','fps','image_width','image_height'])    df_image_timestamps = pd.DataFrame(columns=['video_id','video_path','image_no','timestamp'])        # obtain videos in video raw folder    raw_videos = sorted(glob.glob(video_raw_folder+'*.mp4'))        for raw_video in raw_videos:                # obtain video information        video_id = raw_video.split('/')[-1].split('.')[0]        dt_video_time = datetime.datetime.strptime(video_id.split('_')[-1],'%Y-%m-%d-%H-%M-%S')        time_diff = (dt_process_time - dt_video_time).total_seconds() / 60                # only process raw videos that were recorded at least 15 minutes before        if time_diff > 15:                        print('\nStarting webcam post processing for {}'.format(video_id))                        # set up time folders            #video_store_folder,video_alphapose_folder,info_dir,video_info_folder = time_folders_setup(f_webcam_dir,'{}:{}'.format(get_str(dt_video_time.hour),get_str(dt_video_time.minute)),system_date='{}-{}-{}'.format(get_str(dt_video_time.year),get_str(dt_video_time.month),get_str(dt_video_time.day)),time_level='day',setup=True)                        # convert raw video to store video            if convert_store:                store_video = convert_store_video(raw_video,video_id,video_store_folder)            else:                # move raw video to store folder                store_video = '{}{}.mp4'.format(video_store_folder,video_id)                os.rename(raw_video, store_video)                            # convert store video to alphapose            if convert_alphapose:                df_webcam_new, df_image_timestamps = convert_alphapose_video(store_video,video_id,video_alphapose_folder,video_info_folder,df_webcam_new,df_image_timestamps)                # save    if len(df_webcam_new) != 0:        df_webcam_new.to_csv(video_info_folder+'{}_info.csv'.format(process_time),index=0)    if len(df_image_timestamps) != 0:        df_image_timestamps.to_csv(video_info_folder+'{}_frame_ts.csv'.format(process_time),index=0)        print('\nEnding webcam post processing for {} at {}'.format(camera_id,process_time))        def start_post_process(f_webcam_dir):        # schedule jobs    schedule.every(15).minutes.do(webcam_post_process,f_webcam_dir=f_webcam_dir)        # start scheduler    try:        while True:            schedule.run_pending()            time.sleep(1)    except KeyboardInterrupt:        print('\nEnding scheduler...')"""----------------------------- options -----------------------------"""parser = argparse.ArgumentParser(description='Webcam Post Processing')parser.add_argument('--station', type=int,                    help='id for station')parser.add_argument('--webcam', type=int, default=0,                    help='id for webcam')parser.add_argument('--webcam_dir', type=str, default='../outputs/',                    help='location of webcam drive')args = parser.parse_args()if __name__ == "__main__":        # create necessary variables    station_id = args.station    webcam = int(args.webcam)    camera_id = '{}_{}'.format(args.station,args.webcam)        code_dir = os.getcwd() +'/'    os.chdir(args.webcam_dir)    webcam_dir = os.getcwd() +'/'    os.chdir(code_dir)        # start webcam post process    start_post_process(webcam_dir)            